<link rel="stylesheet" type="text/css" href="https://forumstatic.ru/files/0015/e5/b7/46268.css?v=3">
<style>
    #moderbot-profile-update-button[disabled],
    #moderbot-profile-update-decorations-button[disabled] {
        background: grey!important;
    }
    #update-message-work-decorations {display: block}
</style>

<div id="moderbot-profile-update-wrapper">

    <div id="moderbot-profile-update-preview">
        <h5 class="moderbot-profile-update-preview-title">предпросмотр профиля</h5>
        <div class="post-author-preview">
            <ul>
                <li class="pa-fld7-preview"><div class="personal_icon"><img src="https://forumstatic.ru/files/001c/11/e3/50665.gif" title="Я часто вижу страх в смотрящих на меня глазах"></div></li> <!-- у кого то может не стоять, соответственно если фона у пользователя нет - это поле тоже вырублено будет -->
                <li class="pa-author-preview"></li>
                <li class="pa-title-preview"></li>
                <li class="pa-avatar-preview"><span class="indOnline-preview">online</span><img src=""></li>
                <li class="pa-fld1-preview"><a href="https://crossfeeling.rusff.me/viewtopic.php?id=8663">ИМЯ ПЕРСОНАЖА</a></li>
                <li class="pa-fld2-preview">--Ваш ЛЗ--</li>
                <li class="pa-fld6-preview">sanctuary</li>
                <li class="pa-fld4-preview"><div class="p_plash" style="background: url(https://forumstatic.ru/files/001c/11/e3/98596.png?v=1)"><b>Верхний текст плашки</b><em>Нижний текст плашки</em></div></li>
            </ul>
            <li class="pa-fld8-preview"><div class="personal_bg"><img src="https://forumstatic.ru/files/001c/11/e3/98596.png?v=1"></div></li> <!-- у кого то может не стоять, соответственно если фона у пользователя нет - это поле тоже вырублено будет -->
        </div>
    </div>
    <div id="moderbot-profile-update-form">
        <div class="moderbot-profile-update-form__container">
            <ul class="moderbot-profile-update-form__container-tabs">
                <li class="moderbot-profile-update-form__container-tab active" tab-name="change_lz" data-logId="moderbot-log">изменить личное звание</li>
                <li class="moderbot-profile-update-form__container-tab" tab-name="mirror" data-logId="moderbot-log-decorations">примерочная (фоны, плашки, иконки)</li>
            </ul>
            <div class="moderbot-profile-update-form__container-sections">
                <div class="moderbot-profile-update-form__container-section" tab-name="change_lz" style="display: block">
                    <div class="moderbot-profile-update-form__container-section-inner">
                        <div id="update-message-work" class="update-message">
                            <ul id="moderbot-log" class="update-message_error-list">
                            </ul>
                        </div>
                        <div id="update-message-success" class="update-message">
                            <h5 class="update-message_status correctly">Дворецкий не нашел ошибок</h5> <!-- это для примера -->
                        </div>
                        <div id="update-message-error" class="update-message"> <!-- display: flex когда есть обновления -->
                            <h5 class="update-message_status error">Обнаруженные ошибки</h5>
                            <ul id="moderbot-profile-update-errors" class="update-message_error-list">
                            </ul>
                        </div>
                        <textarea id="moderbot-profile-update-message" class="moderbot-profile-update-fld input-lz" placeholder="Введите личное звание, используя HTML"></textarea>
                        <div class="moderbot-profile-update-submit update-lz">
                            <button class="moderbot-profile-update-button" name="preview-submit" onclick="check()">
                                Посмотреть
                            </button>
                            <button id="moderbot-profile-update-button" class="moderbot-profile-update-button" name="preview-save" disabled onclick="callBot({2: document.getElementById('moderbot-profile-update-message').value})">
                                Сохранить
                            </button>
                        </div>
                    </div>
                </div>
                <div class="moderbot-profile-update-form__container-section" tab-name="mirror">
                    <div class="moderbot-profile-update-form__container-section-inner">
                        <div id="update-message-work-decorations" class="update-message">
                            <ul id="moderbot-log-decorations" class="update-message_error-list">
                            </ul>
                        </div>
                        <div class="moderbot-profile-update-form__box">
                            <h5 class="moderbot-profile-update-form__box-title">Установка плашки</h5>
                            <div class="moderbot-profile-update-form__box-content">
                                <input type="hidden" id="moderbot-batter-text-id" />
                                <input type="text" id="moderbot-batter-text-top" class="moderbot-profile-update-fld input-banner-text-top" placeholder="Верхний текст плашки">
                                <input type="text" id="moderbot-batter-text-bottom" class="moderbot-profile-update-fld input-banner-text-bottom" placeholder="Нижкий текст плашки">
                                <input type="text" id="moderbot-batter-text-img" class="moderbot-profile-update-fld input-banner-img" placeholder="Ссылка на картинку">
                            </div>
                        </div>
                        <div class="moderbot-profile-update-form__box">
                            <h5 class="moderbot-profile-update-form__box-title">Установка фона</h5>
                            <div class="moderbot-profile-update-form__box-content">
                                <input type="text" id="moderbot-bg-img" class="moderbot-profile-update-fld input-bg-img" placeholder="Ссылка на картинку">
                            </div>
                        </div>
                        <div class="moderbot-profile-update-form__box">
                            <h5 class="moderbot-profile-update-form__box-title">Установка иконки</h5>
                            <div class="moderbot-profile-update-form__box-content">
                                <input type="text" id="moderbot-icon-text" class="moderbot-profile-update-fld input-icon-text" placeholder="Подпись для иконки (текст, который будет выводиться по наведению)">
                                <input type="text" id="moderbot-icon-img" class="moderbot-profile-update-fld input-icon-img" placeholder="Своя ссылка на картинку или выберете из галлереи">
                            </div>
                            <h5 class="moderbot-profile-update-form__box-title">Галлерея иконок</h5>
                            <div id="moderbot-icons-gallery" class="moderbot-profile-update-form__box-content icons-gallery">
                                <h5 class="icons-gallery-title">Осенние иконки</h5>
                            </div>
                        </div>
                        <div class="moderbot-profile-update-submit update-appearance">
                            <button class="moderbot-profile-update-button" name="preview-submit" onclick="checkDecorations()">
                                Посмотреть
                            </button>
                            <button id="moderbot-profile-update-decorations-button"
                                    class="moderbot-profile-update-button" name="preview-save" disabled
                                    onclick="updateDecorations()">
                                Сохранить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- для вкладок скрипт -->
<script>
    window.botLogId = 'moderbot-log';
    document.addEventListener("DOMContentLoaded", function () {
        $(".moderbot-profile-update-form__container-tab").on("click", function () {
            const container = $(this).closest('.moderbot-profile-update-form__container');

            const target = $(this).attr("tab-name");
            window.botLogId = $(this).attr("data-logId");

            container.find(".moderbot-profile-update-form__container-tab").removeClass("active");
            $(this).addClass("active");

            container.find(".moderbot-profile-update-form__container-section").each(function () {
                const sectionName = $(this).attr("tab-name");
                if (sectionName === target) {
                    $(this).stop().slideDown(300);
                } else {
                    $(this).stop().slideUp(300);
                }
            });
        });
    });
</script>
<script src="https://forumstatic.ru/files/001b/f1/83/36962.js"></script>
<script>
    let data = {};
    let sendDecorations = false;
    function loadPreview() {
        document.querySelector('.pa-author-preview').innerText = UserLogin;
        document.querySelector('.pa-title-preview').innerText = UserTitle;
        document.querySelector('.pa-avatar-preview img').setAttribute('src', UserAvatar);

        if (typeof UserFld1 != 'undefined') {
            const profile = decodeEscaping(UserFld1);
            document.querySelector('.pa-fld1-preview').innerHTML = profile;
        }

        if (typeof UserFld2 != 'undefined') {
            const charName = decodeEscaping(UserFld2);
            document.getElementById('moderbot-profile-update-message').value = charName;
            document.querySelector('.pa-fld2-preview').innerHTML = charName;
        }

        if (typeof UserFld4 != 'undefined') {
            const oldPlate = decodeEscaping(UserFld4);
            const id = oldPlate.match(/a id="([^"]*)"/)[1];
            const textTop =  oldPlate.match(/<b>([^>]*)<\/b>/)[1];
            const textBottom =  oldPlate.match(/<em>([^>]*)<\/em>/)[1];
            const textImg = oldPlate.match(/url\(([^)]*)\)/)[1];
            document.getElementById('moderbot-batter-text-id').value = id;
            document.getElementById('moderbot-batter-text-top').value = textTop;
            document.getElementById('moderbot-batter-text-bottom').value = textBottom;
            document.getElementById('moderbot-batter-text-img').value = textImg;
            document.querySelector('.pa-fld4-preview').innerHTML = generatePlate(id, textImg, textTop, textBottom);
        }

        if (typeof UserFld8 != 'undefined') {
            const oldBackground = decodeEscaping(UserFld8);
            const backgroundImage = oldBackground.match(/src="([^"]*)"/)[1];
            document.getElementById('moderbot-bg-img').value = backgroundImage;
            document.querySelector('.pa-fld8-preview').innerHTML = generateBackground(backgroundImage);
        }

        if (typeof UserFld7 != 'undefined') {
            oldIcon = decodeEscaping(UserFld7);
            const iconText =  oldIcon.match(/title="([^"]*)"/)[1];
            const iconImg = oldIcon.match(/src="([^"]*)"/)[1];
            document.getElementById('moderbot-icon-text').value = iconText;
            document.getElementById('moderbot-icon-img').value = iconImg;
            document.querySelector('.pa-fld7-preview').innerHTML = generateIcon(iconImg, iconText);

        }
    }

    function decodeEscaping(escaped) {
        const txt = document.createElement("textarea");
        txt.innerHTML = escaped;
        return txt.value;
    }

    function check() {
        const correct_message = document.getElementById('update-message-success');
        const error_message = document.getElementById('update-message-error');
        const s = document.getElementById('moderbot-profile-update-message').value;
        const res = validate(s);
        if (res.status === 'valid') {
            error_message.style.display = 'none';
            correct_message.style.display = 'block';
            document.getElementById('moderbot-profile-update-button').disabled = false;
            document.getElementById('moderbot-profile-update-errors').innerHTML = 'All good!';
            document.querySelector('.pa-fld2-preview').innerHTML = s;
        } else {
            const errorBox = document.getElementById('moderbot-profile-update-errors');
            correct_message.style.display = 'none';
            error_message.style.display = 'block';
            errorBox.innerHTML = '';
            for (const error of res.errors) {
                errorBox.innerHTML += '<li>'+error+'</li>';
            }
        }
    }

    function generatePlate(id, textImg, textTop, textBottom) {
        return '<a id="' + id + '" class="modal-link" href="#" data-reveal-id="character"><div class="p_plash" style="background: url(' + textImg + ')"><b>' + textTop + '</b><em>' + textBottom + '</em></div></a>';
    }

    function generateBackground(backgroundImg) {
        return '<div class="personal_bg"><img src="'+backgroundImg+'"></div>';
    }

    function generateIcon(iconImg, iconText) {
        return '<div class="personal_icon"><img src="' + iconImg + '" title="' + iconText + '"></div>';
    }

    function checkDecorations() {
        let id = document.getElementById('moderbot-batter-text-id').value;
        let textTop = document.getElementById('moderbot-batter-text-top').value;
        let textBottom = document.getElementById('moderbot-batter-text-bottom').value;
        let textImg = document.getElementById('moderbot-batter-text-img').value;
        let errors = false;

        if (textTop.length || textBottom.length || textImg.length) {
            if(!textTop.length) {
                document.getElementById('moderbot-batter-text-top').classList.add('error');
                errors = true;
            }
            if(!textBottom.length) {
                document.getElementById('moderbot-batter-text-bottom').classList.add('warning');
            }
            if(!textImg.length) {
                document.getElementById('moderbot-batter-text-img').classList.add('warning');
            }

            if(textTop.length) {
                sendDecorations = true;
                const plate = generatePlate(id, textImg, textTop, textBottom);
                document.querySelector('.pa-fld4-preview').innerHTML = plate;
                data[4] = plate;
            }
        }

        const backgroundImg = document.getElementById('moderbot-bg-img').value;
        if (backgroundImg.length) {
            sendDecorations = true;
            const background = generateBackground(backgroundImg);
            document.querySelector('.pa-fld8-preview').innerHTML = background;
            data[8] = background;
        }

        let iconText = document.getElementById('moderbot-icon-text').value;
        let iconImg = document.getElementById('moderbot-icon-img').value;
        if (iconText.length || iconImg.length) {

            if(!iconText.length) {
                document.getElementById('moderbot-icon-text').classList.add('error');
                errors = true;
            }
            if(!iconImg.length) {
                document.getElementById('moderbot-icon-img').classList.add('error');
                errors = true;
            }

            if (iconImg.length && iconText.length) {
                sendDecorations = true;
                const icon = generateIcon(iconImg, iconText);
                document.querySelector('.pa-fld7-preview').innerHTML = icon;
                data[7] = icon;
            }
        }

        if(!errors) {
            document.getElementById('moderbot-profile-update-decorations-button').disabled = false;
        }
    }

    function updateDecorations() {
        if (sendDecorations) {
            callBot(data);
        } else {
            alert('You have not changed anything');
        }
    }

    loadPreview();
</script>

<script>
    async function parseIconsFile(fileUrl) {
        icons = {}
        const text = await fetch(fileUrl)
            .then(response => response.text())
            .then(text => text);
        const rows = text.split('\n');
        let category = '';
        for (const row of rows) {
            if (row.indexOf('https://') === -1 && row[0] !== '-' && row.replace(' ', '').length) {
                category = row;
                icons[category] = [];
            }
            if (row[0] === '-' || !row.replace(' ', '').length) {
                continue;
            }
            if (row.indexOf('https://') !== -1) {
                icons[category].push(row);
            }
        }

        const iconsContainer = document.getElementById('moderbot-icons-gallery');
        iconsContainer.innerHTML = '';
        for (const category in icons) {
            const categoryTitle = document.createElement('h5');
            categoryTitle.className = 'icons-gallery-title';
            categoryTitle.innerText = category;
            iconsContainer.appendChild(categoryTitle);
            const categoryList = document.createElement('ul');
            categoryList.className = 'icons-gallery_list';
            icons[category].forEach(icon => {
                categoryList.innerHTML += `<li onclick="pickIcon('${icon}', this)"><img src="${icon}"/></li>`;
            })
            iconsContainer.appendChild(categoryList);
        }
    }

    function pickIcon(source, elem) {
        document.getElementById('moderbot-icon-img').value = source;
        document.querySelectorAll('.icons-gallery_list li').forEach((el) => {
            el.classList.remove('checked')
        })
        elem.classList.add('checked')
    }

    parseIconsFile('https://forumstatic.ru/files/001b/f1/83/40096.txt');
</script>

<script>
    // Connect to WebSocket server
    const ws = new WebSocket("wss://crossfeel.ru");

    ws.onopen = () => {
        console.log("Connected to server");
    };

    ws.onmessage = (event) => {
        try {
            const msg = JSON.parse(event.data);
            if (msg.type && msg.message) {
                log(`[${msg.type}] ${msg.message}`);
            } else {
                console.log(JSON.stringify(msg));
            }
        } catch (e) {
            console.log(event.data);
        }
    };

    ws.onerror = (error) => {
        console.log("WebSocket error: " + error);
    };

    ws.onclose = () => {
        console.log("Disconnected from server");
    };

    function log(message) {
        document.getElementById(window.botLogId).innerHTML += '<li>'+message+'</li>';
    }

    function callBot(data) {
        const update_message = document.getElementById('update-message-work');
        const correct_message = document.getElementById('update-message-success');
        const error_message = document.getElementById('update-message-error');
        error_message.style.display = 'none';
        correct_message.style.display = 'none';
        update_message.style.display = 'block';

        const profileId = UserID;

        const payload = {
            command: "profile_update",
            data: []
        };
        for (let [fieldId, fieldValue] of Object.entries(data)) {

            payload.data.push({
                profile_id: parseInt(profileId, 10),
                field_number: fieldId,
                field_value: fieldValue
            });
        }

        ws.send(JSON.stringify(payload));
    }
</script>
